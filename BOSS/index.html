<html class="a-fullscreen">
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta aframe-injected="" name="mobile-web-app-capable" content="yes">
      <meta aframe-injected="" name="theme-color" content="black">
      <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
      <script defer src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-aframe.prod.js"></script>
      <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
      <link rel="stylesheet" type="text/css" href="styles.css">
   </head>
   <body>
      <img src="ui/Logo_Boss.png" style="position: fixed; top: 8%; left: 50%; transform: translateX(-50%); width: 40vw; height: auto;">
      <button id="end-button" class="flex-center clickable" style="display: none; position: fixed; top: 0; width: 100%; background-color: black; color: white; padding: 20px; font-size: 25px; line-height: 0;">
      <img id="button-img" src="ui/SwitchCam_Icon.png" alt="Image description" style="height: 150%; vertical-align: middle;">
      Turn to face camera
      </button>
      <img id="front-camera-image" src="ui/Cadre.png" style="display: none; max-width: 100%; height: auto;">
      <div id="custom-scanning-overlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
         <img src="UI/Production_Outline.png" style="width: 50%; height: auto; object-fit: cover;">
      </div>
      
      <button id="capture-button" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1;">Take photo</button>
      <canvas id="photo-canvas" style="position: fixed; top: 0; left: 0; z-index: 2;"></canvas> <!-- Make the canvas visible -->




      <a-scene inspector="url: https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js"
         id="ar-scene" mindar-image="imageTargetSrc: targets.mind; uiError:no; uiLoading:no; uiScanning: #custom-scanning-overlay; filterMinCF:0.0001; filterBeta: 0.1; missTolerance: 10; warmupTolerance: 20"
         color-space="sRGB"
         renderer="colorManagement: true, physicallyCorrectLights: false, logarithmicDepthBuffer: false"
         vr-mode-ui="enabled: false"
         device-orientation-permission-ui="enabled: false"
         inspector=""
         keyboard-shortcuts=""
         screenshot="">

         <a-assets>
            <a-asset-item id="avatarModel"
               src="BOSS-ELIXIR-AR02.glb"></a-asset-item>
         </a-assets>

         <a-camera position="0 0 0"
            look-controls="enabled: false"
            cursor="fuse: false; rayOrigin: mouse;"
            raycaster="far: ${customFields.libVersion}; objects: .clickable"
            camera="active: true"
            rotation="0 0 0"
            wasd-controls="enabled: false">
         </a-camera>

         <a-entity id="animated-model" mindar-image-target="targetIndex: 0">
            <a-gltf-model rotation="0 0 0 "
               position="0 -1.5 -1.5"
               scale="4.5 4.3 4.5"
               src="#avatarModel"
               gltf-model=""
               animation-mixer="loop: once; clampWhenFinished: true; timeScale: 0"
               class="clickable"
               limit-rotation>
            </a-gltf-model>

            <a-image src="ui/Touch_Icon.png"
               position="0 0.5 -0.8"
               scale="0.75 0.5 0.5"
               rotation="0 0 0">
            </a-image>
         </a-entity>

         <canvas class="a-canvas"
            data-aframe-canvas="true"
            width="1080"
            height="1920"></canvas>
         <div class="a-loader-title" style="display: none"></div>


         <a-entity light="intensity: 0.5; decay: 0; shadowCameraVisible: false" position="-90 0 30" visible="" rotation="" scale=""></a-entity>
         <a-entity light="intensity: 0.5; decay: 0; shadowCameraVisible: false" position="-22.92 0 30" visible="" rotation="" scale=""></a-entity>
         <a-entity light="intensity: 0.5; decay: 0; shadowCameraVisible: false" position="10 0 70" visible="" rotation="" scale=""></a-entity>
         <a-entity light="intensity: 0.5; decay: 0; shadowCameraVisible: false" position="10 1.76 -0.56" visible="" rotation="" scale=""></a-entity>
         <a-entity light="intensity: 0.5; decay: 0; shadowCameraVisible: false" position="10 1.76 1.13" visible="" rotation="" scale=""></a-entity>
         <a-entity light="intensity: 0.5; decay: 0; shadowCameraVisible: false" position="10 1.76 8.79" visible="" rotation="" scale=""></a-entity>
         <a-entity light="intensity: 0.5; decay: 0; distance: 10; shadowCameraVisible: false" position="-40 1.25 2" visible="" rotation="" scale=""></a-entity>


      </a-scene>

      <video id="userVideo" 
         autoplay=""
         muted=""
         playsinline=""
         width="480"
         height="640"
         style="
         position: absolute;
         top: 0px;
         left: -104.875px;
         z-index: -2;
         width: 633.75px;
         height: 845px;
         "></video>

        <script>
          let currentStream;
          let appState = {
            cameraFrontActive: false,
          };

          function stopMediaTracks(stream) {
            stream.getTracks().forEach(track => {
              track.stop();
            });
          }

          function switchCamera() {
            if (typeof currentStream !== 'undefined') {
              stopMediaTracks(currentStream);
            }

            let videoConstraints;

            // Switch between 'user' and 'environment' cameras
            if (document.querySelector('video').srcObject.getVideoTracks()[0].getSettings().facingMode === 'user') {
              videoConstraints = {
                video: { 
                  facingMode: 'environment' 
                }
              };
              appState.cameraFrontActive = false;
            } else {
              videoConstraints = {
                video: { 
                  facingMode: 'user',
                  width: { ideal: 1280 },
                  height: { ideal: 720 } 
                }
              };
              appState.cameraFrontActive = true;
            }

            document.querySelector('video').style.transform = "scaleX(-1)";

            // Afficher ou masquer l'image en fonction de l'état de la caméra
            let frontCameraImage = document.querySelector('#front-camera-image');
            let logoImage = document.querySelector('img[src="ui/Logo_Boss.png"]');
            let productionOutlineImage = document.querySelector('img[src="UI/Production_Outline.png"]');
            let switchCameraButton = document.querySelector('#end-button');
            
            if (appState.cameraFrontActive) {
                frontCameraImage.style.display = 'block';
                logoImage.style.display = 'none';
                productionOutlineImage.style.display = 'none';
                switchCameraButton.style.display = 'none';
            } else {
                frontCameraImage.style.display = 'none';
                logoImage.style.display = 'block';
                productionOutlineImage.style.display = 'block';
                switchCameraButton.style.display = 'flex';
            }

            navigator.mediaDevices.getUserMedia(videoConstraints)
              .then(stream => {
                currentStream = stream;
                document.querySelector('video').srcObject = stream;
                let sceneEl = document.querySelector('a-scene');
                let arSystem = sceneEl.systems['mindar-image-system'];
                arSystem.stop();
        
                // get the 3D model entity
                const model = document.querySelector('#animated-model');

                // remove the 3D model from the scene
                model.parentNode.removeChild(model);
                console.log(arSystem)
              })
              .catch(error => {
                console.error('Error accessing media devices.', error);
              });
          }
         
         // Initialize video stream on page load
         navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
             .then(stream => {
                 currentStream = stream;
                 document.querySelector('video').srcObject = stream;
             })
             .catch(err => console.log("Error in accessing user media: ", err));
         window.addEventListener('DOMContentLoaded', (event) => {
           let model = document.querySelector('#animated-model a-gltf-model');
           let touchIcon = document.querySelector('#animated-model a-image');
           let touchCount = 0;
         
           function startAnimation() {
             console.log('Animation started!');
             model.setAttribute('animation-mixer', 'loop: once; clampWhenFinished: true; timeScale: 1');
             console.log('Current timeScale:', model.components['animation-mixer'].mixer.timeScale);
         
             if (model.components['animation-mixer'].mixer.timeScale == 1) {
               touchIcon.setAttribute('visible', 'false');
               document.body.removeEventListener('touchstart', touchStartHandler);
             } else {
               touchIcon.setAttribute('visible', 'true');
             }
         
             setTimeout(() => {
               let endButton = document.querySelector('#end-button');
               endButton.style.height = '7%';
               endButton.style.display = 'flex';
               endButton.style.display = 'block';
               console.log('Affichage du bouton');
         
               endButton.addEventListener('click', function() {
                 console.log('Switch camera button was clicked!');
                 switchCamera(); // Utilisez la fonction switchCamera() que vous avez définie précédemment
               });
             }, 1000);
           }
         
           function touchStartHandler() {
             touchCount += 1;
             console.log('touchstart event triggered');
             if (touchCount >= 2) {
               startAnimation();
               touchCount = 0;
             }
           }
         
           model.addEventListener('model-loaded', () => {
             document.body.addEventListener('touchstart', touchStartHandler);
           });
         });
         
         AFRAME.registerComponent('limit-rotation', {
           tick: function () {
             var rotation = this.el.getAttribute('rotation');
             if (rotation.x > 30) { rotation.x = 30; }
             if (rotation.x < -30) { rotation.x = -30; }
             if (rotation.y > 30) { rotation.y = 30; }
             if (rotation.y < -30) { rotation.y = -30; }
             if (rotation.z > 30) { rotation.z = 30; }
             if (rotation.z < -30) { rotation.z = -30; }
             this.el.setAttribute('rotation', rotation);
           }
         });

        document.querySelector('#capture-button').addEventListener('click', function() {
            console.log("Capture button was clicked!");

            var videoElement = document.querySelector('video');
            var canvasElement = document.querySelector('#photo-canvas');
            var context = canvasElement.getContext('2d');

            // Get the position and size of the frame image.
            var frameImg = document.querySelector('#front-camera-image');
            var frameRect = frameImg.getBoundingClientRect();
            var frameX = frameRect.left;
            var frameY = frameRect.top;
            var frameWidth = frameRect.width;
            var frameHeight = frameRect.height;

            // Resize the canvas to match the size of the frame.
            canvasElement.width = frameWidth;
            canvasElement.height = frameHeight;

            // Calculate the scale factor to match the video's size to the frame's size.
            var videoWidth = videoElement.videoWidth;
            var videoHeight = videoElement.videoHeight;
            var scaleFactor = frameWidth / videoWidth;
            var scaledHeight = videoHeight * scaleFactor;

            // Flip context horizontally.
            context.save();
            context.scale(-1, 1);
            context.drawImage(videoElement, -frameWidth, (frameHeight - scaledHeight) / 2, frameWidth, scaledHeight);
            context.restore();

            // Draw the frame image on top of the video.
            context.drawImage(frameImg, 0, 0, frameWidth, frameHeight);

            var dataUrl = canvasElement.toDataURL('image/png');

            // Log the data URL.
            console.log("Data URL:", dataUrl);

            // Create a new image element.
            var imgElement = new Image();

            // Set the src of the image to the data URL of the canvas.
            imgElement.src = dataUrl;

            // Show the image.
            imgElement.style.display = 'block';
            imgElement.style.position = 'fixed';
            imgElement.style.top = '0';
            imgElement.style.zIndex = '3';

            // Add the image to the page.
            document.body.appendChild(imgElement);
        });



      </script>
   </body>
</html>