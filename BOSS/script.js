let currentStream,appState={cameraFrontActive:!1};document.body.style.backgroundColor="#333333";var videoStream,mediaRecorder,isRecording=!1;function init(){navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(function(e){videoStream=e}),initRecorderButton(),console.log("Fonction init")}var recordedChunks=[];function initRecorderButton(){var e=document.getElementById("Recorder"),t=document.getElementById("capture-button-fake"),a=document.getElementById("Recording"),r=document.getElementById("Camera");e.addEventListener("click",function(){this.classList.add("clicked-animation"),setTimeout(()=>this.classList.remove("clicked-animation"),500),t.style.display="none",a.style.display="flex",console.log("Bouton recorder touch\xe9")}),r.addEventListener("click",function(){this.classList.add("clicked-animation"),setTimeout(()=>this.classList.remove("clicked-animation"),500),a.style.display="none",t.style.display="flex",console.log("Camera image touch\xe9")}),t.addEventListener("click",function(){t.classList.add("clicked-animation"),setTimeout(function(){t.classList.remove("clicked-animation")},500)}),a.addEventListener("click",function(){isRecording?(stopRecording(),console.log("End of recording")):(startRecording(),console.log("Recording")),isRecording=!isRecording}),document.querySelector("#capture-button-fake").addEventListener("click",function(){appState.cameraFrontActive?document.querySelector("#capture-button").click():takeSnapshot(),console.log("Snapshot taken")})}function takeSnapshot(){var e=document.querySelector("a-scene");e.components.screenshot.capture("perspective");var t=document.createElement("canvas");t.width=2*window.innerWidth,t.height=2*window.innerHeight;var a=t.getContext("2d"),r=document.createElement("video");r.srcObject=videoStream,r.play(),document.getElementById("logoBoss"),r.onplaying=function(){var i=r.videoWidth/r.videoHeight,n=t.width,o=n/i;o>t.height&&(n=(o=t.height)*i);var c=(t.width-n)/2,d=(t.height-o)/2;a.drawImage(r,c,d,n,o);var l=new Image;l.src=e.components.screenshot.getCanvas("perspective").toDataURL(),l.onload=function(){a.drawImage(l,0,0,t.width,t.height);var e=document.createElement("img");e.src=t.toDataURL("image/png");var r=document.createElement("a");r.href=e.src,r.download="snapshot.png",r.click()}}}var recordingImg=document.getElementById("Recording");function startRecording(){var e=document.querySelector("a-scene").canvas,t=document.createElement("canvas"),a=t.getContext("2d");t.width=2*window.innerWidth,t.height=2*window.innerHeight;var r=document.createElement("video");r.srcObject=videoStream,r.addEventListener("loadedmetadata",function(){var i,n=r.videoWidth/r.videoHeight,o=t.width,c=o/n;c>t.height&&(o=(c=t.height)*n),r.play();var d=(t.width-o)/2,l=(t.height-c)/2;requestAnimationFrame(function i(){a.clearRect(0,0,t.width,t.height),a.drawImage(r,d,l,o,c),a.drawImage(e,0,0,t.width,t.height),isRecording&&requestAnimationFrame(i)})});var i=t.captureStream(60);(mediaRecorder=new MediaRecorder(i,{mimeType:"video/webm; codecs=vp9"})).ondataavailable=function(e){recordedChunks.push(e.data)},mediaRecorder.onstop=function(){var e=new Blob(recordedChunks,{type:"video/mp4"});recordedChunks=[];var t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="recording.mp4",a.click(),recordingImg.style.animation=""},mediaRecorder.start(),recordingImg.style.animation="recordingAnim 2s ease 0s infinite normal forwards"}function stopRecording(){mediaRecorder.stop(),mediaRecorder.onstop=function(){var e=new Blob(recordedChunks,{type:"video/mp4"});recordedChunks=[];var t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="recording.mp4",a.click(),mediaRecorder.stream.getTracks().forEach(e=>e.stop()),recordingImg.style.animation=""}}function stopMediaTracks(e){e.getTracks().forEach(e=>{e.stop()})}let isCameraStarted=!1;function switchCamera(){void 0!==currentStream&&stopMediaTracks(currentStream);let e;document.querySelector("#filtre"),isCameraStarted?(appState.cameraFrontActive?(e={video:{facingMode:"environment",width:{min:640,ideal:1920,max:1920},height:{min:400,ideal:1080},frameRate:{ideal:60}}},appState.cameraFrontActive=!1):(e={video:{facingMode:"user",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:60}}},appState.cameraFrontActive=!0),navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia(e).then(function(e){var t=document.getElementById("userVideo");t.srcObject=e,t.autoplay=!0,t.playsinline=!0,currentStream=e}).catch(function(e){console.log("Something went wrong!")})):(appState.cameraFrontActive?(e={video:{facingMode:"environment",width:{min:640,ideal:1920,max:1920},height:{min:400,ideal:1080},frameRate:{ideal:60}}},appState.cameraFrontActive=!1):(e={video:{facingMode:"user",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:60}}},appState.cameraFrontActive=!0),navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia(e).then(function(e){var t=document.getElementById("userVideo");t.srcObject=e,t.autoplay=!0,t.playsinline=!0,currentStream=e}).catch(function(e){console.log("Something went wrong!")}),isCameraStarted=!0),document.querySelector("video").style.transform="scaleX(-1)";let t=document.querySelector("#front-camera-image"),a=document.querySelector('img[src="ui/Logo_Boss.png"]'),r=document.querySelector('img[src="ui/Production_Outline_complete.png"]'),i=document.querySelector("#end-button");document.querySelector("#capture-button-fake"),appState.cameraFrontActive?(t.style.display="block",a.style.display="none",r.style.display="none",i.style.display="none",document.querySelector(".center-div-container").style.display="none",document.querySelector("#Recorder").style.display="none",document.querySelector("#Switch-button-fake").style.display="none"):(t.style.display="none",a.style.display="block",r.style.display="block",i.style.display="flex"),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(e).then(e=>{currentStream=e,document.querySelector("video").srcObject=e;let t=document.querySelector("a-scene").systems["mindar-image-system"];t.stop();let a=document.querySelector("#animated-model");a.parentNode.removeChild(a),console.log(t)}).catch(e=>{console.error("Error accessing media devices.",e)}):navigator.getUserMedia?navigator.getUserMedia(e,function(e){currentStream=e,document.querySelector("video").srcObject=e;let t=document.querySelector("a-scene").systems["mindar-image-system"];t.stop();let a=document.querySelector("#animated-model");a.parentNode.removeChild(a),console.log(t)},function(e){console.log("An error occurred: "+e)}):console.log("Your browser does not support getUserMedia API")}navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(e=>{currentStream=e,document.querySelector("video").srcObject=e,appState.cameraFrontActive=!1}).catch(e=>console.log("Error in accessing user media: ",e)):navigator.getUserMedia?navigator.getUserMedia({video:{facingMode:"environment"}},function(e){currentStream=e,document.querySelector("video").srcObject=e,appState.cameraFrontActive=!1},function(e){console.log("An error occurred: "+e)}):console.log("Your browser does not support getUserMedia API"),document.addEventListener("DOMContentLoaded",function(){init()}),window.addEventListener("DOMContentLoaded",e=>{let t=document.querySelector("#animated-model a-gltf-model"),a=document.querySelector("#animated-model a-image"),r=0,i=document.querySelector(".center-div");function n(){console.log("Animation started!"),t.setAttribute("animation-mixer","loop: once; clampWhenFinished: true; timeScale: 1"),console.log("Current timeScale:",t.components["animation-mixer"].mixer.timeScale),1==t.components["animation-mixer"].mixer.timeScale?(a.setAttribute("visible","false"),document.body.removeEventListener("touchstart",o)):a.setAttribute("visible","true"),setTimeout(()=>{let e=document.querySelector("#end-button");e.style.height="7%",e.style.display="flex",e.style.display="block",console.log("Affichage du bouton"),document.getElementById("Switch-button-fake").addEventListener("click",function(){console.log("Switch camera button was clicked!"),switchCamera()}),e.addEventListener("click",function(){console.log("Switch camera button was clicked!"),switchCamera()})},1e3)}function o(){r+=1,console.log("touchstart event triggered"),r>=2&&(n(),r=0)}t.addEventListener("model-loaded",()=>{i.addEventListener("touchstart",o)})}),AFRAME.registerComponent("limit-rotation",{tick:function(){var e=this.el.getAttribute("rotation");e.x>30&&(e.x=30),e.x<-30&&(e.x=-30),e.y>30&&(e.y=30),e.y<-30&&(e.y=-30),e.z>30&&(e.z=30),e.z<-30&&(e.z=-30),this.el.setAttribute("rotation",e)}}),window.onload=function(){var e=document.querySelector("#capture-button"),t=document.querySelector("#share-button"),a=document.querySelector("#download-button"),r=document.querySelector("#restart-button"),i=document.querySelector("video");document.querySelector("#front-camera-image"),document.querySelector("#restart-button").addEventListener("click",function e(){var t=document.querySelector("#photo-canvas"),a=document.querySelector("#captured-image"),r=document.getElementById("capture-button-fake");t.width=t.width,document.body.style.backgroundColor="#333333",document.querySelector("#capture-button").style.display="none",r.style.display="block",document.querySelector("#share-button").style.display="none",document.querySelector("#download-button").style.display="none",document.querySelector("#restart-button").style.display="none",a&&a.remove(),document.querySelector("#front-camera-image").style.display="block",navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(function(e){i.srcObject=e}).catch(function(e){console.log("An error occurred: "+e)})}),e.addEventListener("click",async()=>{console.log("Capture button was clicked!");var i,n,o=document.getElementById("capture-button-fake");e.style.display="none",o.style.display="none",t.style.display="block",a.style.display="block",r.style.display="flex",t.style.width="175px",t.style.height="auto",a.style.width="175px",a.style.height="auto";var c,d,l,s,m,u=document.querySelector("video"),g=document.querySelector("#front-camera-image");g.getBoundingClientRect();let h=(d=2*(c=u).videoWidth,l=2*c.videoHeight,(s=document.createElement("canvas")).width=d,s.height=l,(m=s.getContext("2d")).scale(-1,1),m.drawImage(c,-d,0,d,l),s);h.toDataURL("image/png");let y=await (i=h,n=414/717,new Promise(e=>{let t=i.width,a=i.height,r=t/a,o=t,c=a;r>n?o=a*n:r<n&&(c=t/n);let d=(t-o)/2,l=(a-c)/2,s=document.createElement("canvas");s.width=o,s.height=c;let m=s.getContext("2d");m.drawImage(i,d,l,o,c,0,0,o,c),e(s)}));var p=document.querySelector("#captured-image");p||((p=new Image).id="captured-image",p.style.display="block",p.style.position="fixed",p.style.top="0",p.style.left="0",p.style.right="0",p.style.width="95%",p.style.height="auto",p.style.margin="auto",p.style.objectFit="cover",p.style.zIndex="2",document.body.style.backgroundColor="#000000",document.body.appendChild(p)),y.toDataURL("image/png");var v=document.createElement("canvas");v.width=y.width,v.height=y.height;var f=v.getContext("2d");f.drawImage(y,0,0,v.width,v.height);var S=document.querySelector("#front-camera-image"),$=S.naturalWidth/S.naturalHeight,w=v.width,b=w/$,k=(v.height-b)/2;f.drawImage(S,0,k,w,b);var q=f.getImageData(0,k,w,b);v.width=w,v.height=b,f.putImageData(q,0,0),p.src=v.toDataURL("image/png"),g.style.display="none";let E=u.srcObject,R=E.getTracks();R.forEach(function(e){e.stop()}),u.srcObject=null,document.body.appendChild(p)}),document.querySelector("#download-button").addEventListener("click",function(){var e=document.createElement("a"),t=document.querySelector("#captured-image");if(t){var a=document.createElement("canvas");a.width=t.naturalWidth,a.height=t.naturalHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height),e.href=a.toDataURL("image/png"),e.download="JeSuisLeBOSS.png",e.click()}else console.log("Image not captured yet")}),document.querySelector("#share-button").addEventListener("click",function(){var e=document.querySelector("#captured-image");if(e&&navigator.canShare){let t=function e(t,a){let r=t.split(","),i=r[0].match(/:(.*?);/)[1],n=atob(r[1]),o=n.length,c=new Uint8Array(o);for(;o--;)c[o]=n.charCodeAt(o);return new File([c],a,{type:i})}(e.src,"myImage.png");navigator.canShare({files:[t]})?navigator.share({files:[t],title:"My Photo",text:"Check out my photo!"}).then(()=>console.log("Successful share")).catch(e=>console.log("Error sharing",e)):console.log("File sharing not supported on this platform.")}else console.log("Web Share API not supported.")})};